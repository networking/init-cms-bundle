{#

This file is part of the Networking package.

(c) net working AG <info@networking.ch>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}
{% autoescape false %}
    <!-- edit one association -->
    <script type="text/javascript">

        // handle the add link
        function getLayoutBlockCreateForm(url, data) {
            $.ajax({
                url: url,
                data: data,
                success: function (html) {
                    var layoutBlockModal = $('#layoutBlockModal');
                    layoutBlockModal.html(html).modal('show');
                    layoutBlockModal.on('hide.bs.modal', function (e) {
                        if($(e.target).attr('id') === layoutBlockModal.attr('id'))
                        {
                            $('#contentTypeModal').off('initcms.create_block');
                            $('li.temp_item').remove();
                            $('form', '#layoutBlockModal').off('submit');
                        }
                    });
                    $('#contentTypeModal').modal('hide');
                    $('#createContentButton').button('reset');
                    $('#contentLoading').hide();
                    $('form', '#layoutBlockModal').on('submit', submitLayoutCreate);
                }
            });
        }

        function submitLayoutCreate(event) {
            event.preventDefault();
            $.each(CKEDITOR.instances, function () {
                try {
                    var editor = this;
                    var text = editor.getData();
                    if (editor) {
                        $('#' + editor.name).val(text);
                    }

                } catch (err) {
                }
            });
            var form = $(this);

            $(form).ajaxSubmit({
                type: form.attr('method'),
                url: form.attr('action'),
                dataType: 'json',
                data: {
                    formFieldId: '{{ id }}',
                    code: '{{ admin.root.code }}',
                    uniqId: '{{  admin.root.uniqid }}',
                    pageId:  '{{ admin.root.id(admin.root.subject) }}'
                },
                success: function (xhr) {
                    if (xhr.result === 'ok') {
                        InitCms.createInitCmsMessageBox(xhr.status, xhr.message);
                        $('#layoutBlockModal').modal('hide');
                        $('#field_container_{{ id }}').replaceWith(xhr.html);
                        $('input[type=submit]', this).off();
                        $('form', '#layoutBlockModal').unbind('submit');
                        saveLayoutBlockSort();
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#layoutBlockModal').html(xhr.responseText);
                    $('.modal').trigger('shown.bs.modal');
                    $('form', '#layoutBlockModal').on('submit', submitLayoutCreate);
                }
            });

            return false;
        }


        function getLayoutBlockEditForm(url){
            $.ajax({
                url: url,
                dataType: 'html',
                success: function (html) {
                    var layoutBlockModal = $('#layoutBlockModal');
                    layoutBlockModal.html(html).modal('show');
                    layoutBlockModal.on('hide.bs.modal', function (e) {
                        if($(e.target).attr('id') === layoutBlockModal.attr('id'))
                        {
                            $('form', '#layoutBlockModal').off('submit');
                        }
                    });
                    $('form', '#layoutBlockModal').on('submit', submitLayoutUpdate);
                }
            });
        }

        function submitLayoutUpdate(event) {
            event.preventDefault();
            $.each(CKEDITOR.instances, function () {
                try {
                    var editor = this;
                    var text = editor.getData();
                    if (editor) {
                        $('#' + editor.name).val(text);
                    }

                } catch (err) {
                }
            });

            var form = $(this);

            $(form).ajaxSubmit({
                type: form.attr('method'),
                url: form.attr('action'),
                data: {
                    formFieldId: '{{ id }}',
                    code: '{{ admin.root.code }}',
                    uniqId: '{{  admin.root.uniqid }}',
                    pageId:  '{{ admin.root.id(admin.root.subject) }}'
                },
                error: function (xhr) {
                    $('#layoutBlockModal').html(xhr.responseText);
                    $('.modal').trigger('shown.bs.modal');
                    $('form', '#layoutBlockModal').on('submit', submitLayoutUpdate);
                },
                success: function (html) {
                    $('#layoutBlockModal').modal('hide');
                    $('#field_container_{{ id }}').replaceWith(html); // replace the html

                    saveLayoutBlockSort();
                }
            });
        }

        function reloadLayoutBlocks(){
            $.ajax({
                type: 'get',
                url: '{{ url('admin_networking_initcms_layoutblock_reload') }}',
                data: {
                    formFieldId: '{{ id }}',
                    code: '{{ admin.root.code }}',
                    uniqId: '{{  admin.root.uniqid }}',
                    pageId:  '{{ admin.root.id(admin.root.subject) }}'
                },success: function (html) {
                    $('#field_container_{{ id }}').replaceWith(html); // replace the html
                }
            });
        }

        function saveLayoutBlockSort(callback) {
            var zones = [];

            $('ul.sortable').each(function (index, el) {
                var list = $(el);
                var zone_name = list.attr('id').substr(5);
                list.find('a.add-layout').each(function (index, el) {
                    $(el).data('sort-order', index);
                    $(el).data('zone', zone_name);
                })
                zones.push({
                    'zone': zone_name,
                    'layoutBlocks': list.sortable("toArray", {key: "layoutBlock"})
                });
            });

            $.when(submitLayoutSort(zones)).done(function (xhr) {
                if (callback !== undefined) {
                    callback(xhr)
                }

                $('body').trigger('layout:sorted', [xhr]);
            });
        }
        
        function submitLayoutSort(zones) {
            var dfd = $.Deferred();
            var pageStatus = $('.page_status');
            return $.ajax({
                url: '{{ url('admin_networking_initcms_layoutblock_updateLayoutBlockSort') }}',
                data: {
                    zones: zones,
                    pageId: '{{ admin.root.id(admin.root.subject) }}',
                    code: '{{ admin.root.code }}'
                },
                type: 'post',
                success: function (xhr) {
                    if (xhr.status !== 'error') {
                        if (xhr.pageStatusSettings !== undefined) $('#pageStatusSettings').html(xhr.pageStatusSettings);
                        if (xhr.pageStatus !== undefined) {
                            if (xhr.pageStatus !== "{{ 'status_published'|trans({}, admin.translationDomain) }}") {
                                pageStatus.addClass('color-draft');
                            } else {
                                pageStatus.removeClass('color-draft');
                            }
                            pageStatus.html(xhr.pageStatus);
                        }
                    }
                    dfd.resolve(xhr);
                }
            });
        }

        function onAfterLoad() {

            $('div#field_container_{{ id }} ul.sortable').sortable({
                handle: 'i.fa-arrows-up-down-left-right',
                opacity: 0.6,
                placeholder: "ui-state-highlight",
                items: 'li.networking-sortable-list',
                connectWith: ".sortable",
                tolerance: 'pointer',
                start: function (event, ui) {
                    $(this).sortable('refreshPositions');
                    var listItems = $(this).find('.networking-sortable-list');
                    if (listItems.length < 1) {
                        $(this).find(".empty_layout_block").show();
                    } else {
                        $(this).find(".empty_layout_block").hide();
                    }
                },
                stop: function (event, ui) {
                    saveLayoutBlockSort(function (xhr) {
                        InitCms.createInitCmsMessageBox(xhr.messageStatus, xhr.message);
                    });
                },
                update: function (event, ui) {
                    var maxItems = $(this).attr('data-max-items');
                    if (maxItems > 0 && $(this).find('li.networking-sortable-list').length >= maxItems) {
                        $(this).find(".plus_button").hide();
                    } else {
                        $(this).find(".plus_button").show();
                    }
                },
                receive: function (event, ui) {

                    var allowedTypes = eval($(this).attr('data-content-types'));
                    var maxItems = $(this).attr('data-max-items');
                    var contentType = $(ui.item).attr('data-content-type');

                    if (allowedTypes.length > 0 && $.inArray(contentType, allowedTypes) < 0) {
                        $(ui.placeholder).addClass('ui-state-error');
                        $(ui.sender).sortable('cancel');

                        if (!$(ui.sender).find('.networking-sortable-list').length < 2) {
                            $(ui.sender).find(".empty_layout_block").hide();
                        }
                        return;
                    }

                    if (maxItems > 0 && $(this).find('li.networking-sortable-list').length > maxItems) {
                        $(ui.placeholder).addClass('ui-state-error');
                        $(ui.sender).sortable('cancel');
                        if (!$(ui.sender).find('.networking-sortable-list').length < 2) {
                            $(ui.sender).find(".empty_layout_block").hide();
                        }
                    } else {
                        $(this).find(".empty_layout_block").hide();
                    }
                },
                change: function (event, ui) {
                    var listItems = $(ui.sender).find('.networking-sortable-list');
                    if (listItems.length <= 1) {
                        $(ui.sender).find(".empty_layout_block").show();
                    } else {
                        $(ui.sender).find(".empty_layout_block").hide();
                    }
                },
                over: function (event, ui) {

                    var allowedTypes = eval($(this).attr('data-content-types'));
                    var maxItems = $(this).attr('data-max-items');
                    var contentType = $(ui.item).attr('data-content-type');
                    var placeholder = $(ui.placeholder);

                    if (allowedTypes.length > 0 && $.inArray(contentType, allowedTypes) < 0) {
                        placeholder.css('display', 'none');
                    } else if (maxItems > 0 && $(this).find('li.networking-sortable-list').length >= maxItems) {

                        if ($(ui.sender).attr('id') === $(this).attr('id')) {
                            placeholder.css('display', 'block');
                        } else {
                            placeholder.css('display', 'none');
                        }
                        $(this).find(".empty_layout_block").hide();
                    }
                    else {
                        placeholder.css('display', 'block');
                        $(this).find(".empty_layout_block").hide();
                    }
                }

            });
        }

        (function ($) {
            // refresh the sortable option when a new element is added
            onAfterLoad();
            $('body').on('click', '.add-layout', function(ev){

                ev.preventDefault();
                var link = $(this);

                var restrictedTypes = eval(link.data('value'));
                var selectContentType = $('#selectContentType');
                var contentTypeModal = $('#contentTypeModal');

                selectContentType.find('option').each(function (i) {
                    if ($.inArray($(this).val(), restrictedTypes) < 0 && restrictedTypes.length > 0) {
                        $(this).attr('disabled', 'disabled');
                    } else {
                        $(this).removeAttr('disabled');
                    }
                });
                selectContentType.val($("#selectContentType option:enabled:first").val());

                contentTypeModal.modal('show');

                contentTypeModal.on('initcms.create_block', function (event) {
                    $('button', '#contentTypeModal').off('click');
                    $('#contentTypeModal').off('initcms.create_block');
                    if ($(this).data('create')) {
                        $('#contentLoading').show();
                        $('#createContentButton').button('loading');
                        var data = {
                            zone: link.data('zone'),
                            sortOrder: link.data('sort-order'),
                            classType: selectContentType.val(),
                            code: '{{ admin.root.code }}',
                            pageId: '{{ admin.root.id(admin.root.subject) }}',
                            uniqId: '{{ admin.root.uniqid }}',
                        };
                        var url = '{{ url('admin_networking_initcms_layoutblock_create') }}';

                        getLayoutBlockCreateForm(url, data);

                    }
                });
            }).on('click', '.layout-link', function(event){
                event.preventDefault();
                getLayoutBlockEditForm($(this).data('href'))
            }).on('click', 'i.delete_block', function () {
                if (confirm('{{ "page_admin.confirm"|trans({}, admin.translationDomain) }}')) {
                    $.ajax({
                        url: '{{ url('admin_networking_initcms_layoutblock_deleteAjax') }}',
                        method: 'POST',
                        data: {
                            id: $(this).attr('data-value'),
                            code: '{{ admin.root.code }}',
                            pageId: '{{ admin.root.id(admin.root.subject) }}',
                            uniqId: '{{ admin.root.uniqid }}',
                            formFieldId: '{{ id }}',
                            _method: 'DELETE'
                        },
                        success: function (xhr) {
                            InitCms.createInitCmsMessageBox(xhr.messageStatus, xhr.message);
                            $('#field_container_{{ id }}').replaceWith(xhr.html);
                            saveLayoutBlockSort();
                        }
                    });
                }
            }).on('click', 'i.toggle-active', function () {
                if (confirm('{{ "page_admin.confirm"|trans({}, admin.translationDomain) }}')) {
                    $.ajax({
                        url: '{{ url('admin_networking_initcms_layoutblock_toggleActive') }}',
                        method: 'POST',
                        data: {
                            id: $(this).attr('data-value'),
                            code: '{{ admin.root.code }}',
                            pageId: '{{ admin.root.id(admin.root.subject) }}',
                            uniqId: '{{ admin.root.uniqid }}',
                            formFieldId: '{{ id }}',
                            _method: 'PUT'
                        },
                        success: function (xhr) {
                            InitCms.createInitCmsMessageBox(xhr.messageStatus, xhr.message);
                            $('#field_container_{{ id }}').replaceWith(xhr.html);
                            saveLayoutBlockSort();
                        }
                    });
                }
            })
            ;
        })($);
    </script>

    <!-- / edit one association -->
{% endautoescape %}
