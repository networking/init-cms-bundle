var CMSMediaAdmin=function(){var e,t,n=null,a=[],o=!0,r=!0,i="";const s=()=>{e||(t=document.querySelector("#tag_dialog"),e=new bootstrap.Modal(t,{height:"auto",width:650,show:!1}))},l=n=>{n.preventDefault();let a=n.target;axios.post(a.action,new FormData(a),axiosConfig).then((n=>{"application/json"===n.headers["content-type"]&&"ok"===n.data.result&&(e.hide(),CMSAdmin.createInitCmsMessageBox(n.data.status,n.data.message),p(n.data.json,n.data.objectId)),t.querySelector(".modal-content").innerHTML=n.data,t.querySelector("form").addEventListener("submit",l),CMSAdmin.initSpecialFields()})).catch((e=>{console.log(e)}))},d=()=>{let e=$(".tag_link");e.unbind(),e.editable({toggle:"manual",url:i,name:"name",display:function(e,t){if(void 0!==t){var n=$(".jstree-icon",this);$(this).html(n).append(e)}}}).on("contextmenu",(function(e){$(this).editable("show"),e.preventDefault()})).on("save",(function(e,t){c(t.newValue,t.response.objectId)})).on("hidden",(function(e,t){if("save"===t){$(this).parent().closest("ul");const e=new URL(window.location.href);let t=e.searchParams;t.set("time",jQuery.now()),e.search=t.toString(),history.replaceState({time:jQuery.now()},"updated",e.toString())}}))},c=(e,t)=>{var a=$(n).jstree(!0).get_json();u(a,e,t,a.length-1),h()},u=(e,t,n,a)=>{if(a<0)return e;var o=e[a];return void 0!==o.data&&o.data.id===n&&(o.text=t,o.li_attr["data-tag-name"]=t),o.children.length>0&&u(o.children,t,n,o.children.length-1),u(e,t,n,a-1)},h=()=>{let e=["sort","types","unique"];o&&e.push("dnd"),r&&e.push("delete");let t=$(n);a=t.data("tagsJson"),i=t.data("inlineEditUrl"),t.jstree({types:{default:{icon:"fa fa-folder text-primary fs-2x"},file:{icon:"fa fa-file text-primary fs-2x"}},plugins:e,dnd:{check_while_dragging:!0,is_draggable:e=>"show_all_media"!==e[0].a_attr.class},sort:function(e,t){let n=this.get_node(e),a=this.get_node(t);return n.data.show_first?-1:a.data.show_first||n.text.toLowerCase()>a.text.toLowerCase()?1:-1},core:{themes:{variant:"large"},check_callback:function(e,t,n,a,o){return"move_node"!==e||!n.a_attr||"show_all_media"!==n.a_attr.class},data:function(e,t){t(a)}}}),t.on("refresh.jstree",(function(){d()})).on("move_node.jstree",(function(e,t){let n=t.new_instance.get_json();var a=m(n,0,0,n.length-1,[]);f(a),d()})).on("after_open.jstree",(function(){d()})).on("redraw.jstree",(function(){d()})),t.on("dragover",(function(e){}))},f=e=>{axios.post(n.dataset.updateTreeUrl,{nodes:e},axiosConfig).then((function(e){var t=e.data;CMSAdmin.createInitCmsMessageBox(t.status,t.message);const n=new URL(window.location.href);let a=n.searchParams;a.set("time",jQuery.now()),n.search=a.toString(),history.replaceState({time:jQuery.now()},"updated",n.toString())}))},m=(e,t,n,a,o)=>{if(a<0)return o;var r=e[a];return r.children.length>0&&o.push.apply(m(r.children,r.data.id,n+1,r.children.length-1,o)),o.push({id:r.data.id,parent_id:t,name:r.text,depth:n}),m(e,t,n,a-1,o)},p=(e,t)=>{a=e,$(n).jstree(!0).refresh()},g=e=>{e||(e=[]);let t=new FormData(document.querySelector("#search-form"));for(const n in e)t.append(n,e[n]);e=Object.fromEntries(t.entries()),axios.get(n.dataset.refreshListUrl,{...axiosConfig,params:e}).then((function(e){$("#item_list").html(e.data),$("html, body").animate({scrollTop:$("#item_list").scrollTop()},"slow"),refreshFsLightbox()}))};return{init:function(){n=document.querySelector("#tagsContainer"),o=n.dataset.canSort,r=n.dataset.canDelete,h(),s(),KTUtil.on(document.body,"a.delete_check_box","click",(function(e){e.preventDefault();let t=!1,n=document.querySelector(".batch-actions");if(document.querySelectorAll(".delete_check_box").forEach((function(e){e.checked?(e.classList.add("ui-selected"),t=!0):e.classList.remove("ui-selected")})),t)return n.classList.remove("d-none");n.classList.add("d-none")})),KTUtil.on(document.body,"a.batch","click",(function(e){e.preventDefault(),document.querySelector("input[name='action']").value=e.target.dataset.value,createBatchDialog(e)})),KTUtil.on(document.body,"a.tag-dialog-link","click",(function(n){n.preventDefault(),(n=>{n.preventDefault(),n.stopPropagation(),s();let a=n.target;a.getAttribute("href")||(a=a.closest("a")),fetch(a.getAttribute("href"),{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}}).then((e=>e.text())).then((n=>{document.querySelector("#tag_dialog").querySelector(".modal-content").innerHTML=n,e.show(),t.querySelector("form").addEventListener("submit",l)}))})(n)})),KTUtil.on(document.body,".tag_link","click",(function(e,t){e.preventDefault();var n=e.target.dataset.pk;void 0===t&&g({"filter[tags][value]":n})})),KTUtil.on(document.body,".show_all_media","click",(function(e,t){e.preventDefault(),g({"filter[_page]":1,"filter[tags][value]":""})})),KTUtil.on(document.body,"a.media-pager","click",(function(e){e.preventDefault();let t=e.target.dataset.page,n=e.target.dataset.sortOrder,a=e.target.dataset.sortBy,o=e.target.dataset.tags,r=e.target.dataset.name;g({"filter[_page]":t,"filter[_sort_order]":n,"filter[_sort_by]":a,"filter[tags][value]":o,"filter[name][value]":r})}))},refreshList:function(e){g(e)}}}();class MediaDropZone{constructor(e){this.element=e,this.context=this.element.dataset.context,this.provider=this.element.dataset.provider,this.uploadForm=this.element.querySelector("#upload-form");const t=this.element.dataset.uniqueId;let n=this.element.querySelector(".dropzone-item");n.id="";let a=n.parentNode.innerHTML;n.parentNode.removeChild(n);const o=this;let r=new Dropzone(this.element,{init:function(){this.on("success",(function(e,t){o.changeButtonRow(e,t),CMSMediaAdmin.refreshList()})),this.on("error",(function(e,t){t.duplicate&&o.changeButtonRow(e,t)}))},url:this.uploadForm.action,params:{context:this.context,provider:this.provider,oneuploader:!0},thumbnailWidth:80,thumbnailHeight:80,parallelUploads:20,previewTemplate:a,previewsContainer:"#previews",clickable:".fileinput-zone"});r.on("totaluploadprogress",(function(e){document.querySelector("#total-progress .progress-bar").style.width=e+"%"})),r.on("sending",(function(e,n,a){let o=document.querySelector("#"+t+"_tags").value;a.append("tags",o),document.querySelector("#total-progress").style.opacity="1"})),r.on("queuecomplete",(function(e){document.querySelector("#total-progress").style.opacity="0"})),document.querySelector("#actions .cancel").onclick=function(){r.removeAllFiles(!0)}}changeButtonRow(e,t){console.log(e);let n=e.previewElement.querySelector("[data-dz-url]");n.href=t.url,n.classList.remove("d-none"),e.previewElement.querySelector(".progress").classList.add("d-none")}}!function(e,t){"use strict";var n=document.createElement("a");n.className="delete-tag dialog-link float-end ",n.innerHTML='<i class="la la-trash fs-2 mx-3"></i>',e.jstree.defaults.delete=e.noop,e.jstree.plugins.delete=function(t,a){this.teardown=function(){this.settings.delete&&this.element.find(".delete-tag").remove(),a.teardown.call(this)},this.redraw_node=function(t,o,r,i){if(t=a.redraw_node.call(this,t,o,r,i),this.get_node(t).children&&this.get_node(t).children.length)return t;if(t&&e(t).hasClass("sortable-tag")){var s=n.cloneNode(!0),l=this.get_node(t);s.href=l.data.delete_link,t.insertBefore(s,t.childNodes[2])}return t}}}($),KTUtil.onDOMContentLoaded((function(){CMSMediaAdmin.init(),document.body.addEventListener("shown.bs.modal",(function(e){let t=e.target.querySelector("#dropzone_area");t&&new MediaDropZone(t)}))}));
//# sourceMappingURL=media-admin.js.map
