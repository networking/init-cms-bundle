{"version":3,"file":"menu-admin.js","names":["CMSMenuAdmin","lastEdited","menuDialog","tabs","updateUrl","lastTab","localStorage","getItem","ready","trees","reloadList","axios","get","dataset","listUrl","locale","document","querySelector","value","axiosConfig","then","response","innerHTML","data","html","hasOwnProperty","setLastEdited","last_edited","setUpSortTree","$","tab","setLastTab","setItem","createAjaxDialog","event","preventDefault","link","target","getAttribute","closest","show","CMSAdmin","createSelect2","submitAjaxForm","stopPropagation","form","post","action","FormData","result","is_new_menu_item","hide","createInitCmsMessageBox","status","message","catch","error","each","e","ui","tree","push","treeData","plugins","attr","jstree","types","default","icon","file","core","themes","variant","check_callback","node","cb","treeSwitch","on","updateMenuSort","new_instance","get_json","element","checked","showHideTree","postMenuLoad","querySelectorAll","forEach","item","id","flattenArray","depth","left","ret","pid","right","children","length","name","text","item_id","parent_id","nodes","doReload","rootId","sort","a","b","handleShowHideTree","treeId","open","find","open_all","close_all","init","KTUtil","lastEditedNode","initMenu","bootstrap","Modal","height","width","reload","undefined","externalUrl","createElement","className","defaults","noop","options","parent","this","teardown","settings","remove","call","redraw_node","obj","deep","callback","force_draw","get_node","tmp","cloneNode","href","path","insertBefore","childNodes","delete","deleteUrl","onDOMContentLoaded"],"sources":["menu-admin.js"],"mappings":"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","sourcesContent":["\nvar CMSMenuAdmin = function () {\n\n    var lastTab = localStorage.getItem('lastTab');\n    var lastEdited;\n    var menuDialog;\n    var tabs;\n    var listUrl;\n    var updateUrl;\n    var ready = false;\n    var trees = [];\n\n    var reloadList = () => {\n        axios.get(tabs.dataset.listUrl, {'locale': document.querySelector('#filter_locale_value').value, ...axiosConfig}\n        ).then(function (response) {\n            tabs.innerHTML = response.data.html;\n\n            if(response.data.hasOwnProperty('last_edited') > -1) {\n                setLastEdited(response.data.last_edited)\n            }\n            setUpSortTree();\n            $('a[href=\"' + lastTab + '\"]').tab('show');\n        })\n    }\n\n    var setLastTab = (tab) => {\n        lastTab = tab;\n        localStorage.setItem('lastTab', lastTab);\n    }\n\n\n\n    var initializeDialog = () => {\n        if (!menuDialog) {\n            menuDialog = new bootstrap.Modal(document.querySelector('#menu_dialog'), {height:'auto', width:650, show: false})\n        }\n    }\n\n    var createAjaxDialog = (event)=> {\n        event.preventDefault();\n\n\n\n        let link = event.target;\n\n        if(!link.getAttribute('href')) {\n            link = link.closest('a');\n        }\n\n\n        let locale = document.querySelector('#filter_locale_value').value\n        axios.get(\n            link.getAttribute('href'),\n            {'locale': locale, ...axiosConfig}\n        ).then(function (response) {\n            document.querySelector('#menu_dialog').querySelector('.modal-content').innerHTML = response.data;\n            menuDialog.show();\n            CMSAdmin.createSelect2();\n        })\n    }\n\n\n    var submitAjaxForm =(event) => {\n        event.preventDefault();\n        event.stopPropagation();\n\n        let form = event.target;\n\n\n        axios.post(form.action, new FormData(form), axiosConfig)\n            .then(function (response) {\n                var data = response.data;\n                if (data.result == 'ok') {\n\n                    if (data.is_new_menu_item && data.html) {\n                        document.querySelector('#menu_dialog').querySelector('.modal-content').innerHTML = data.html;\n                    } else {\n                        menuDialog.hide();\n                        CMSAdmin.createInitCmsMessageBox(data.status, data.message);\n                    }\n                    reloadList();\n                }\n            })\n            .catch(function (error) {\n                return false;\n                var data = error.response.data;\n                if (typeof data === 'object') {\n                    $('.modal-body').prepend('<div class=\"alert alert-danger\">' + data.message + ' <br>' + data.errors.join('<br>') + '</div>');\n                } else {\n                    menuDialog.html(data);\n                }\n            })\n    }\n\n    var setUpSortTree = () => {\n        $('div.menu_tree').each(function (e, ui) {\n            let tree = $(ui);\n\n            trees.push(tree)\n\n            let treeData = tree.data('tree');\n            let plugins = ['dnd', 'types','changed'];\n\n            if (tree.attr('id') !== 'placement_menu') {\n                plugins.push('externalUrl');\n                plugins.push('delete');\n            }\n            tree.jstree({\n                \"types\": {\n                    \"default\": {\n                        \"icon\": \"la la-file text-primary fs-2x\"\n                    },\n                    \"file\": {\n                        \"icon\": \"la la-file text-primary fs-2x\"\n                    }\n                },\n                \"plugins\": plugins,\n                'core': {\n                    \"themes\": {\n                        \"variant\": \"large\",\n                    },\n\n                    \"check_callback\": true,\n                    data: function (node, cb) {\n                        cb(treeData)\n                    }\n                }\n            });\n\n            let treeSwitch = document.querySelector('[data-tree-id=\"' + tree.attr('id') + '\"]')\n\n            tree.on(\"move_node.jstree\", function (e, data) {\n                updateMenuSort(data.new_instance.get_json(), ($(data.new_instance.element[0]).attr('id') === 'placement_menu'))\n\n                if (treeSwitch && treeSwitch.checked) {\n                    showHideTree(treeSwitch)\n                }\n\n            });\n\n            tree.on('after_close.jstree', function (e, data) {\n                treeSwitch.checked = false\n            })\n\n            if (ready) {\n                return;\n            }\n\n            tree.on('ready.jstree', function () {\n                ready = true;\n                postMenuLoad();\n            });\n\n        });\n    }\n\n\n    var postMenuLoad = () => {\n\n        document.querySelectorAll('[data-tree-id]').forEach(function (item) {\n            showHideTree(item)\n        })\n    }\n\n    var setLastEdited = (id) => {\n        lastEdited = id;\n    }\n\n    var flattenArray = (item, depth, left, ret, pid) => {\n        var right = left + 1,\n            id = item.data.id,\n            pid;\n\n\n        if (item.children.length > 0) {\n            depth++;\n            item.children.forEach(function (node) {\n                right = flattenArray(node, depth, right, ret, id);\n            });\n            depth--;\n        }\n\n        if (id) {\n            ret.push({\n                \"name\": item.text,\n                \"item_id\": id,\n                \"parent_id\": pid,\n                \"depth\": depth,\n                \"left\": left,\n                \"right\": right\n            });\n        }\n\n        left = right + 1;\n        return left;\n    }\n\n    var updateMenuSort = (nodes, doReload) => {\n        var ret = [];\n        var left = 2;\n\n\n\n        nodes.forEach(function (node) {\n            left = flattenArray(node, 1, left, ret, node.data.rootId);\n        })\n\n        ret = ret.sort(function (a, b) {\n            return (a.left - b.left);\n        });\n\n        axios.post(updateUrl, {\"nodes\": ret}, axiosConfig)\n            .then(function (response) {\n                CMSAdmin.createInitCmsMessageBox('success', response.data.message);\n                menuDialog.hide();\n                if (doReload) {\n                    reloadList()\n                }\n            })\n    }\n\n    var handleShowHideTree = (event) => {\n        let treeSwitch = event.target;\n        showHideTree(treeSwitch)\n    }\n\n    var showHideTree = (treeSwitch) => {\n        let treeId = treeSwitch.dataset.treeId;\n        let open = treeSwitch.checked\n\n        localStorage.setItem('tree_' + treeId, open)\n        trees.find((tree) => {\n            if(tree.attr('id') === treeId) {\n                if(open) {\n                    return tree.jstree(true).open_all()\n                }\n                return tree.jstree(true).close_all()\n            }\n        })\n\n    }\n\n    var initMenu = () => {\n        tabs = document.querySelector('#menuTabs')\n\n        lastTab = localStorage.getItem('lastTab');\n        lastEdited = tabs.dataset.lastEdited;\n        listUrl = tabs.dataset.listUrl\n        updateUrl = tabs.dataset.updateUrl\n\n        document.querySelectorAll('[data-tree-id]').forEach(function (item) {\n            item.checked = localStorage.getItem('tree_' + item.dataset.treeId) !== 'false'\n        })\n        setUpSortTree();\n        KTUtil.on(document.querySelector('#menuTabs'), '.menu-dialog-link', 'click', createAjaxDialog);\n        KTUtil.on(document.querySelector('#menu_dialog'), 'form', 'submit', submitAjaxForm);\n        KTUtil.on(document.querySelector('#menuTabs'), '.tree-show-all', 'click', handleShowHideTree);\n\n        $('body').on('shown.bs.tab', function (e) {\n            setLastTab($(e.target).attr('href'));\n        });\n\n        if (lastEdited) {\n            var lastEditedNode = $('#menu-item-' + lastEdited);\n            lastTab = '#menu_' + lastEditedNode.data('root-id');\n            setLastTab(lastTab);\n        }\n\n        if (lastTab) {\n            $('a[href=\"' + lastTab + '\"]').tab('show');\n        }\n    }\n\n    return {\n        init: function () {\n            initMenu();\n            initializeDialog();\n        },\n        reload: function () {\n            reloadList();\n        }\n    }\n}();\n\n\n\n(function ($, undefined) {\n    \"use strict\";\n\n    var externalUrl = document.createElement('a');\n    externalUrl.className = \"external-url float-end\";\n    $.jstree.defaults.externalUrl = $.noop;\n    $.jstree.plugins.externalUrl = function (options, parent) {\n        this.teardown = function () {\n            if (this.settings.externalUrl) {\n                this.element.find(\".external-url\").remove();\n            }\n            parent.teardown.call(this);\n        };\n        this.redraw_node = function (obj, deep, callback, force_draw) {\n\n            obj = parent.redraw_node.call(this, obj, deep, callback, force_draw);\n            var node = this.get_node(obj);\n            var tmp = externalUrl.cloneNode(true);\n            tmp.href = node.data.externalUrl;\n            tmp.innerHTML = node.data.path\n            obj.insertBefore(tmp, obj.childNodes[2]);\n            return obj;\n        };\n    };\n\n    var link = document.createElement('a');\n    link.className = \"delete-tag menu-dialog-link float-end \";\n    link.innerHTML = '<i class=\"la la-trash fs-2 mx-3\"></i>';\n\n    $.jstree.defaults.delete = $.noop;\n    $.jstree.plugins.delete = function (options, parent) {\n\n        this.teardown = function () {\n            if (this.settings.delete) {\n                this.element.find(\".delete-tag\").remove();\n            }\n            parent.teardown.call(this);\n        };\n        this.redraw_node = function (obj, deep, callback, force_draw) {\n\n            obj = parent.redraw_node.call(this, obj, deep, callback, force_draw);\n\n            var tmp = link.cloneNode(true);\n            var node = this.get_node(obj);\n            tmp.href = node.data.deleteUrl;\n            obj.insertBefore(tmp, obj.childNodes[2]);\n            return obj;\n        };\n    };\n\n\n})($);\n\n// On document ready\nKTUtil.onDOMContentLoaded(function () {\n    CMSMenuAdmin.init();\n});"]}