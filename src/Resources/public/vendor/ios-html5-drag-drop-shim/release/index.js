!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.MobileDragDrop=t.MobileDragDrop||{})}(this,(function(t){"use strict";var e;var r,a={iterationInterval:150};function o(t){if(console.log("dnd-poly: global touchstart"),r)console.log("dnd-poly: drag operation already active");else{var e=function(t){var e=t.target;do{if(!1!==e.draggable&&e.getAttribute&&"true"===e.getAttribute("draggable"))return e}while((e=e.parentNode)&&e!==document.body)}(t);if(e)try{r=new u(t,a,e,n)}catch(e){throw n(a,t,3),e}}}function n(t,e,a){if(0===a&&(console.log("dnd-poly: Drag never started. Last event was "+e.type),t.defaultActionOverride))try{t.defaultActionOverride(e),e.defaultPrevented&&console.log("dnd-poly: defaultActionOverride has taken care of triggering the default action. preventing default on original event")}catch(t){console.log("dnd-poly: error in defaultActionOverride: "+t)}r=null}var i=["none","copy","copyLink","copyMove","link","linkMove","move","all"],d=["none","copy","move","link"],s=["","-webkit-"],c="dnd-poly-",l="dnd-poly-drag-image",g="dnd-poly-snapback",h="dnd-poly-icon",u=function(){function t(t,e,r,a){this._initialEvent=t,this._config=e,this._sourceNode=r,this._dragOperationEndedCb=a,this._dragOperationState=0,this._immediateUserSelection=null,this._currentDropTarget=null,console.log("dnd-poly: setting up potential drag operation.."),this._lastTouchEvent=t,this._initialTouch=t.changedTouches[0],this._touchMoveHandler=this._onTouchMove.bind(this),this._touchEndOrCancelHandler=this._onTouchEndOrCancel.bind(this),_("touchmove",this._touchMoveHandler,!1),_("touchend",this._touchEndOrCancelHandler,!1),_("touchcancel",this._touchEndOrCancelHandler,!1)}return t.prototype._setup=function(){var t=this;console.log("dnd-poly: starting drag and drop operation"),this._dragOperationState=1,this._currentDragOperation=d[0],this._dragDataStore={_data:{},_effectAllowed:void 0,_mode:3,_types:[]},this._currentHotspotCoordinates={x:null,y:null},this._dragImagePageCoordinates={x:null,y:null};var e,r,a=this._sourceNode;if(this._dataTransfer=new f(this._dragDataStore,(function(e,r,o){a=e,"number"!=typeof r&&"number"!=typeof o||(t._dragImageOffset={x:r||0,y:o||0})})),this._dragDataStore._mode=2,this._dataTransfer.dropEffect=d[0],S("dragstart",this._sourceNode,this._lastTouchEvent,this._dragDataStore,this._dataTransfer))return console.log("dnd-poly: dragstart cancelled"),this._dragOperationState=3,this._cleanup(),!1;if(T("page",this._lastTouchEvent,this._dragImagePageCoordinates),this._dragImage=(r=(e=a).cloneNode(!0),O(e,r),r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.zIndex="999999",r.classList.add(l),r.classList.add(h),r),this._dragImageTransforms=function(t){return s.map((function(e){var r=t.style[e+"transform"];return r&&"none"!==r?r.replace(/translate\(\D*\d+[^,]*,\D*\d+[^,]*\)\s*/g,""):""}))}(this._dragImage),!this._dragImageOffset)if(this._config.dragImageOffset)this._dragImageOffset={x:this._config.dragImageOffset.x,y:this._config.dragImageOffset.y};else if(this._config.dragImageCenterOnTouch){var o=getComputedStyle(a);this._dragImageOffset={x:0-parseInt(o.marginLeft,10),y:0-parseInt(o.marginTop,10)}}else{var n=a.getBoundingClientRect();o=getComputedStyle(a);this._dragImageOffset={x:n.left-this._initialTouch.clientX-parseInt(o.marginLeft,10)+n.width/2,y:n.top-this._initialTouch.clientY-parseInt(o.marginTop,10)+n.height/2}}return D(this._dragImage,this._dragImagePageCoordinates,this._dragImageTransforms,this._dragImageOffset,this._config.dragImageCenterOnTouch),document.body.appendChild(this._dragImage),this._iterationIntervalId=setInterval((function(){t._iterationLock?console.log("dnd-poly: iteration skipped because previous iteration hast not yet finished."):(t._iterationLock=!0,t._dragAndDropProcessModelIteration(),t._iterationLock=!1)}),this._config.iterationInterval),!0},t.prototype._cleanup=function(){console.log("dnd-poly: cleanup"),this._iterationIntervalId&&(clearInterval(this._iterationIntervalId),this._iterationIntervalId=null),p("touchmove",this._touchMoveHandler),p("touchend",this._touchEndOrCancelHandler),p("touchcancel",this._touchEndOrCancelHandler),this._dragImage&&(this._dragImage.parentNode.removeChild(this._dragImage),this._dragImage=null),this._dragOperationEndedCb(this._config,this._lastTouchEvent,this._dragOperationState)},t.prototype._onTouchMove=function(t){var e=this;if(!1!==y(t,this._initialTouch.identifier)){if(this._lastTouchEvent=t,0===this._dragOperationState){var r=void 0;if(this._config.dragStartConditionOverride)try{r=this._config.dragStartConditionOverride(t)}catch(t){console.error("dnd-poly: error in dragStartConditionOverride hook: "+t),r=!1}else r=1===t.touches.length;return r?void(!0===this._setup()&&(this._initialEvent.preventDefault(),t.preventDefault())):void this._cleanup()}if(console.log("dnd-poly: moving draggable.."),t.preventDefault(),T("client",t,this._currentHotspotCoordinates),T("page",t,this._dragImagePageCoordinates),this._config.dragImageTranslateOverride)try{var a=!1;if(this._config.dragImageTranslateOverride(t,{x:this._currentHotspotCoordinates.x,y:this._currentHotspotCoordinates.y},this._immediateUserSelection,(function(t,r){e._dragImage&&(a=!0,e._currentHotspotCoordinates.x+=t,e._currentHotspotCoordinates.y+=r,e._dragImagePageCoordinates.x+=t,e._dragImagePageCoordinates.y+=r,D(e._dragImage,e._dragImagePageCoordinates,e._dragImageTransforms,e._dragImageOffset,e._config.dragImageCenterOnTouch))})),a)return}catch(t){console.log("dnd-poly: error in dragImageTranslateOverride hook: "+t)}D(this._dragImage,this._dragImagePageCoordinates,this._dragImageTransforms,this._dragImageOffset,this._config.dragImageCenterOnTouch)}},t.prototype._onTouchEndOrCancel=function(t){if(!1!==y(t,this._initialTouch.identifier)){if(this._config.dragImageTranslateOverride)try{this._config.dragImageTranslateOverride(void 0,void 0,void 0,(function(){}))}catch(t){console.log("dnd-poly: error in dragImageTranslateOverride hook: "+t)}0!==this._dragOperationState?(t.preventDefault(),this._dragOperationState="touchcancel"===t.type?3:2):this._cleanup()}},t.prototype._dragAndDropProcessModelIteration=function(){var t=this,e=this._currentDragOperation;this._dragDataStore._mode=3,this._dataTransfer.dropEffect=d[0];var r=S("drag",this._sourceNode,this._lastTouchEvent,this._dragDataStore,this._dataTransfer);if(r&&(console.log("dnd-poly: drag event cancelled."),this._currentDragOperation=d[0]),r||2===this._dragOperationState||3===this._dragOperationState)return this._dragOperationEnded(this._dragOperationState)?void function(t,e,r,a){var o=getComputedStyle(t);if("hidden"===o.visibility||"none"===o.display)return console.log("dnd-poly: source node is not visible. skipping snapback transition."),void a();e.classList.add(g);var n=getComputedStyle(e),i=parseFloat(n.transitionDuration);if(isNaN(i)||0===i)return console.log("dnd-poly: no transition used - skipping snapback"),void a();console.log("dnd-poly: starting dragimage snap back");var d=t.getBoundingClientRect(),s={x:d.left,y:d.top};s.x+=document.body.scrollLeft||document.documentElement.scrollLeft,s.y+=document.body.scrollTop||document.documentElement.scrollTop,s.x-=parseInt(o.marginLeft,10),s.y-=parseInt(o.marginTop,10);var c=parseFloat(n.transitionDelay),l=Math.round(1e3*(i+c));D(e,s,r,void 0,!1),setTimeout(a,l)}(this._sourceNode,this._dragImage,this._dragImageTransforms,(function(){t._finishDragOperation()})):void this._finishDragOperation();var a=document.elementFromPoint(this._currentHotspotCoordinates.x,this._currentHotspotCoordinates.y);console.log("dnd-poly: new immediate user selection is: "+a);var o=this._currentDropTarget;a!==this._immediateUserSelection&&a!==this._currentDropTarget&&(this._immediateUserSelection=a,null!==this._currentDropTarget&&(this._dragDataStore._mode=3,this._dataTransfer.dropEffect=d[0],S("dragexit",this._currentDropTarget,this._lastTouchEvent,this._dragDataStore,this._dataTransfer,!1)),null===this._immediateUserSelection?(this._currentDropTarget=this._immediateUserSelection,console.log("dnd-poly: current drop target changed to null")):(this._dragDataStore._mode=3,this._dataTransfer.dropEffect=I(this._dragDataStore._effectAllowed,this._sourceNode),S("dragenter",this._immediateUserSelection,this._lastTouchEvent,this._dragDataStore,this._dataTransfer)?(console.log("dnd-poly: dragenter default prevented"),this._currentDropTarget=this._immediateUserSelection,this._currentDragOperation=E(this._dataTransfer.effectAllowed,this._dataTransfer.dropEffect)):this._immediateUserSelection!==document.body&&(this._currentDropTarget=document.body))),o!==this._currentDropTarget&&v(o)&&(console.log("dnd-poly: current drop target changed."),this._dragDataStore._mode=3,this._dataTransfer.dropEffect=d[0],S("dragleave",o,this._lastTouchEvent,this._dragDataStore,this._dataTransfer,!1,this._currentDropTarget)),v(this._currentDropTarget)&&(this._dragDataStore._mode=3,this._dataTransfer.dropEffect=I(this._dragDataStore._effectAllowed,this._sourceNode),!1===S("dragover",this._currentDropTarget,this._lastTouchEvent,this._dragDataStore,this._dataTransfer)?(console.log("dnd-poly: dragover not prevented on possible drop-target."),this._currentDragOperation=d[0]):(console.log("dnd-poly: dragover prevented."),this._currentDragOperation=E(this._dataTransfer.effectAllowed,this._dataTransfer.dropEffect))),console.log("dnd-poly: d'n'd iteration ended. current drag operation: "+this._currentDragOperation),e!==this._currentDragOperation&&this._dragImage.classList.remove(c+e);var n=c+this._currentDragOperation;!1===this._dragImage.classList.contains(n)&&this._dragImage.classList.add(n)},t.prototype._dragOperationEnded=function(t){console.log("dnd-poly: drag operation end detected with "+this._currentDragOperation);var e=this._currentDragOperation===d[0]||null===this._currentDropTarget||3===t;return e?v(this._currentDropTarget)&&(this._dragDataStore._mode=3,this._dataTransfer.dropEffect=d[0],S("dragleave",this._currentDropTarget,this._lastTouchEvent,this._dragDataStore,this._dataTransfer,!1)):v(this._currentDropTarget)&&(this._dragDataStore._mode=1,this._dataTransfer.dropEffect=this._currentDragOperation,!0===S("drop",this._currentDropTarget,this._lastTouchEvent,this._dragDataStore,this._dataTransfer)?this._currentDragOperation=this._dataTransfer.dropEffect:this._currentDragOperation=d[0]),e},t.prototype._finishDragOperation=function(){console.log("dnd-poly: dragimage snap back transition ended"),this._dragDataStore._mode=3,this._dataTransfer.dropEffect=this._currentDragOperation,S("dragend",this._sourceNode,this._lastTouchEvent,this._dragDataStore,this._dataTransfer,!1),this._dragOperationState=2,this._cleanup()},t}(),f=function(){function t(t,e){this._dataStore=t,this._setDragImageHandler=e,this._dropEffect=d[0]}return Object.defineProperty(t.prototype,"types",{get:function(){if(0!==this._dataStore._mode)return Object.freeze(this._dataStore._types)},enumerable:!0,configurable:!0}),t.prototype.setData=function(t,e){if(2===this._dataStore._mode){if(t.indexOf(" ")>-1)throw new Error("illegal arg: type contains space");this._dataStore._data[t]=e,-1===this._dataStore._types.indexOf(t)&&this._dataStore._types.push(t)}},t.prototype.getData=function(t){if(1===this._dataStore._mode||2===this._dataStore._mode)return this._dataStore._data[t]||""},t.prototype.clearData=function(t){if(2===this._dataStore._mode){if(t&&this._dataStore._data[t]){delete this._dataStore._data[t];var e=this._dataStore._types.indexOf(t);return void(e>-1&&this._dataStore._types.splice(e,1))}this._dataStore._data={},this._dataStore._types=[]}},t.prototype.setDragImage=function(t,e,r){2===this._dataStore._mode&&this._setDragImageHandler(t,e,r)},Object.defineProperty(t.prototype,"effectAllowed",{get:function(){return this._dataStore._effectAllowed},set:function(t){2===this._dataStore._mode&&i.indexOf(t)>-1&&(this._dataStore._effectAllowed=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dropEffect",{get:function(){return this._dropEffect},set:function(t){0!==this._dataStore._mode&&i.indexOf(t)>-1&&(this._dropEffect=t)},enumerable:!0,configurable:!0}),t}();function _(t,r,a){void 0===a&&(a=!0),document.addEventListener(t,r,!!e&&{passive:a})}function p(t,e){document.removeEventListener(t,e)}function m(t){return 0===t.length?0:t.reduce((function(t,e){return e+t}),0)/t.length}function v(t){return t&&t.tagName}function y(t,e){for(var r=0;r<t.changedTouches.length;r++){if(t.changedTouches[r].identifier===e)return!0}return!1}function T(t,e,r){for(var a=[],o=[],n=0;n<e.touches.length;n++){var i=e.touches[n];a.push(i[t+"X"]),o.push(i[t+"Y"])}r.x=m(a),r.y=m(o)}function O(t,e){if(1===t.nodeType){for(var r=getComputedStyle(t),a=0;a<r.length;a++){var o=r[a];e.style.setProperty(o,r.getPropertyValue(o),r.getPropertyPriority(o))}e.style.pointerEvents="none",e.removeAttribute("id"),e.removeAttribute("class"),e.removeAttribute("draggable")}if(t.hasChildNodes())for(a=0;a<t.childNodes.length;a++)O(t.childNodes[a],e.childNodes[a])}function D(t,e,r,a,o){void 0===o&&(o=!0);var n=e.x,i=e.y;a&&(n+=a.x,i+=a.y),o&&(n-=parseInt(t.offsetWidth,10)/2,i-=parseInt(t.offsetHeight,10)/2);for(var d="translate3d("+n+"px,"+i+"px, 0)",c=0;c<s.length;c++){var l=s[c]+"transform";t.style[l]=d+" "+r[c]}}function I(t,e){return t?t===i[0]?d[0]:0===t.indexOf(i[1])||t===i[7]?d[1]:0===t.indexOf(i[4])?d[3]:t===i[6]?d[2]:d[1]:3===e.nodeType&&"A"===e.tagName?d[3]:d[1]}function S(t,e,r,a,o,n,i){void 0===n&&(n=!0),void 0===i&&(i=null),console.log("dnd-poly: dispatching "+t);var d=function(t,e,r,a,o,n,i){void 0===i&&(i=null);var d=e.changedTouches[0],s=new Event(r,{bubbles:!0,cancelable:a});s.dataTransfer=n,s.relatedTarget=i,s.screenX=d.screenX,s.screenY=d.screenY,s.clientX=d.clientX,s.clientY=d.clientY,s.pageX=d.pageX,s.pageY=d.pageY;var c=t.getBoundingClientRect();return s.offsetX=s.clientX-c.left,s.offsetY=s.clientY-c.top,s}(e,r,t,n,document.defaultView,o,i),s=!e.dispatchEvent(d);return a._mode=0,s}function E(t,e){if(!t||t===i[7])return e;if(e===d[1]){if(0===t.indexOf(d[1]))return d[1]}else if(e===d[3]){if(0===t.indexOf(d[3])||t.indexOf("Link")>-1)return d[3]}else if(e===d[2]&&(0===t.indexOf(d[2])||t.indexOf("Move")>-1))return d[2];return d[0]}function b(t){var e=t.target,r=function(){i.off(),d.off(),s.off(),clearTimeout(n)},n=setTimeout((function(){i.off(),d.off(),s.off(),o(t)}),a.holdToDrag),i=C(e,"touchend",r,this),d=C(e,"touchcancel",r,this),s=C(window,"scroll",r,this)}function C(t,e,r,a){return a&&(r=r.bind(a)),t.addEventListener(e,r),{off:function(){return t.removeEventListener(e,r)}}}t.polyfill=function(t){if(t&&Object.keys(t).forEach((function(e){a[e]=t[e]})),!a.forceApply){var r=(n={dragEvents:"ondragstart"in document.documentElement,draggable:"draggable"in document.documentElement,touchEvents:"ontouchstart"in document.documentElement,userAgentSupportingNativeDnD:void 0},i=!!window.chrome||/chrome/i.test(navigator.userAgent),n.userAgentSupportingNativeDnD=!(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)||i&&n.touchEvents),n);if(r.userAgentSupportingNativeDnD&&r.draggable&&r.dragEvents)return!1}var n,i;return console.log("dnd-poly: Applying mobile drag and drop polyfill."),e=function(){var t=!1;try{var e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("test",null,e)}catch(t){}return t}(),a.holdToDrag?_("touchstart",b,!1):_("touchstart",o,!1),!0},Object.defineProperty(t,"__esModule",{value:!0})}));